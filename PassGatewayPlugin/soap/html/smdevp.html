<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>The smdevp engine</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="smdevp">The smdevp engine </a></h1><p>The gSOAP smdevp engine computes (signed) message digests over any type of data using the EVP interface of OpenSSL. It currently supports MD5, SHA1, HMAC_SHA1, DSA_SHA1, and RSA_SHA1.</p>
<p>A digest or signature algorithm is selected with one the following constants:</p>
<ul>
<li>SOAP_SMD_DGST_MD5 to compute MD5 128-bit digests</li>
<li>SOAP_SMD_DGST_SHA1 to compute MD5 160-bit digests</li>
<li>SOAP_SMD_HMAC_SHA1 to compute HMAC-SHA1 message authentication code</li>
<li>SOAP_SMD_SIGN_DSA_SHA1 to compute DSA-SHA1 signatures</li>
<li>SOAP_SMD_SIGN_RSA_SHA1 to compute RSA-SHA1 signatures</li>
<li>SOAP_SMD_VRFY_DSA_SHA1 to verify DSA-SHA1 signatures</li>
<li>SOAP_SMD_VRFY_RSA_SHA1 to verify RSA-SHA1 signatures</li>
</ul>
<p>The smdevp engine wraps the EVP API with three new functions:</p>
<ul>
<li>soap_smd_init to initialize the engine</li>
<li>soap_smd_update to update the state with a message part</li>
<li>soap_smd_final to compute the digest, signature, or verify a signature</li>
</ul>
<p>A higher-level interface for computing (signed) message digests over messages produced by the gSOAP enginre is defined by two new functions:</p>
<ul>
<li>soap_smd_begin to start a digest or signature computation/verification</li>
<li>soap_smd_end to complete a digest/signature computation/verification</li>
</ul>
<p>Here is an example to sign an XML serialized C++ object using an RSA private key applied to the SHA1 digest of the serialized object:</p>
<div class="fragment"><pre class="fragment">    ns__Object *<span class="keywordtype">object</span> = ...;
    <span class="keywordtype">int</span> alg = SOAP_SMD_SIGN_RSA_SHA1;
    FILE *fd = fopen(<span class="stringliteral">&quot;key.pem&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);
    EVP_PKEY *key = PEM_read_PrivateKey(fd, NULL, NULL, <span class="stringliteral">&quot;password&quot;</span>);
    <span class="keywordtype">char</span> *sig = (<span class="keywordtype">char</span>*)soap_malloc(soap, soap_smd_size(alg, key));
    <span class="keywordtype">int</span> siglen;
    fclose(fd);
    <span class="keywordflow">if</span> (soap_smd_begin(soap, alg, key, 0)
     || soap_out_ns__Object(soap, <span class="stringliteral">&quot;ns:Object&quot;</span>, 0, <span class="keywordtype">object</span>, NULL)
     || soap_smd_end(soap, sig, &amp;siglen))
      soap_print_fault(soap, stderr);
    <span class="keywordflow">else</span>
      ... <span class="comment">// sig contains RSA-SHA1 signature of length siglen </span>
</pre></div><p>To verify the signature, we use the RSA public key and re-run the octet stream (by re-serialization in this example) through the smdevp engine using the SOAP_SMD_VRFY_RSA_SHA1 algorithm. Note that a PEM file may contain both the (encrypted) private and public keys.</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">char</span> *sig = ...;
    <span class="keywordtype">int</span> siglen = ...;
    ns__Object *<span class="keywordtype">object</span> = ...;
    <span class="keywordtype">int</span> alg = SOAP_SMD_VRFY_RSA_SHA1;
    FILE *fd = fopen(<span class="stringliteral">&quot;key.pem&quot;</span>, <span class="stringliteral">&quot;r&quot;</span>);
    EVP_PKEY *key = PEM_read_PUBKEY(fd, NULL, NULL, NULL);
    fclose(fd);
    <span class="keywordflow">if</span> (soap_smd_begin(soap, alg, key, 0)
     || soap_out_ns__Object(soap, <span class="stringliteral">&quot;ns:Object&quot;</span>, 0, <span class="keywordtype">object</span>, NULL)
     || soap_smd_end(soap, sig, &amp;siglen))
      soap_print_fault(soap, stderr);
    <span class="keywordflow">else</span>
      ... <span class="comment">// sig verified, i.e. signed object was not changed</span>
</pre></div><p>The HMAC algorithm uses a secret key (which both the sender and receiver must keep secret) to sign and verify a message:</p>
<div class="fragment"><pre class="fragment">    ns__Object *<span class="keywordtype">object</span> = ...;
    <span class="keywordtype">int</span> alg = SOAP_SMD_HMAC_SHA1;
    <span class="keyword">static</span> <span class="keywordtype">char</span> key[16] =
    { 0xff, 0xee, 0xdd, 0xcc, 0xbb, 0xaa, 0x99, 0x88,
      0x77, 0x66, 0x55, 0x44, 0x33, 0x22, 0x11, 0x00 };
    <span class="keywordtype">char</span> *sig = (<span class="keywordtype">char</span>*)soap_malloc(soap, soap_smd_size(alg, NULL));
    <span class="keywordtype">int</span> siglen;
    <span class="keywordflow">if</span> (soap_smd_begin(soap, alg, key, <span class="keyword">sizeof</span>(key))
     || soap_out_ns__Object(soap, <span class="stringliteral">&quot;ns:Object&quot;</span>, 0, <span class="keywordtype">object</span>, NULL)
     || soap_smd_end(soap, sig, &amp;siglen))
      soap_print_fault(soap, stderr);
    <span class="keywordflow">else</span>
      ... <span class="comment">// sig holds the signature</span>
</pre></div><p>Note: HMAC signature verification proceeds by recomputing the signature value for comparison.</p>
<p>A digest is a hash value of an octet stream computed using the MD5 or SHA1 algorithms:</p>
<div class="fragment"><pre class="fragment">    ns__Object *<span class="keywordtype">object</span> = ...;
    <span class="keywordtype">int</span> alg = SOAP_SMD_DGST_SHA1;
    <span class="keywordtype">char</span> *digest = (<span class="keywordtype">char</span>*)soap_malloc(soap, soap_smd_size(alg, NULL));
    <span class="keywordtype">int</span> digestlen;
    <span class="keywordflow">if</span> (soap_smd_begin(soap, alg, NULL, 0)
     || soap_out_ns__Object(soap, <span class="stringliteral">&quot;ns:Object&quot;</span>, 0, <span class="keywordtype">object</span>, NULL)
     || soap_smd_end(soap, digest, &amp;digestlen))
      soap_print_fault(soap, stderr);
    <span class="keywordflow">else</span>
      ... <span class="comment">// digest holds hash value of serialized object</span>
</pre></div><p>Note that indentation (SOAP_XML_INDENT) and exc-c14n canonicalization (SOAP_XML_CANONICAL) affects the XML serialization format and, therefore, the digest or signature produced. </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Wed Sep 21 16:00:06 2011 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
